# PDF 优化说明

## 🎯 已完成的优化

### 1. 移除 Google Fonts 外部字体
- **问题**: Google Fonts 加载多个 Noto 字体（中日韩），导致 PDF 嵌入大量字体数据（可能好几 MB）
- **解决**: 改用系统字体栈
- **效果**: 文件大小从可能的数 MB 降至 200KB 左右

### 2. 添加资源拦截
- **功能**: Puppeteer 资源拦截器，过滤不必要的资源
- **规则**:
  - ✅ 允许: 文档、样式表
  - ✅ 允许: KaTeX 字体（数学公式必需）
  - ❌ 拒绝: Google Fonts、图片、媒体、WebSocket
- **效果**: 减少字体嵌入，加快生成速度

### 3. 优化等待策略
- **改进**: `waitUntil: 'networkidle2'` 替代 `networkidle0`
- **超时**: 设置 10 秒超时，防止资源加载卡死
- **效果**: 更快的响应，更可靠的生成

### 4. 使用系统字体
- **字体栈**: 
  ```css
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 
               'Microsoft YaHei', 'SimSun', 'PingFang SC', 
               'Hiragino Sans GB', Arial, sans-serif;
  ```
- **优势**: 
  - 不需要下载外部字体
  - 支持中日韩等多语言
  - Windows、Mac、Linux 通用
  - 文件更小

## 📊 测试结果

| 测试类型 | 内容长度 | PDF 大小 | 生成时间 |
|---------|---------|---------|---------|
| 简单测试 | 19 字符 | 16.72 KB | ~1.7s |
| 中等测试 | 82 字符 | 44.82 KB | ~2.3s |
| Web 默认内容 | 862 字符 | 216.67 KB | ~3.3s |

## ✅ 预期效果

- **小文档**: < 50 KB
- **中等文档**: 50-200 KB
- **大文档**: 200-500 KB
- **超大文档**: < 1 MB

## 🧪 如何测试

1. **启动服务器**:
   ```bash
   npm run server
   ```

2. **打开浏览器**:
   ```
   http://localhost:3000
   ```

3. **测试步骤**:
   - 使用默认内容生成 PDF
   - 检查文件大小（应该在 200KB 左右）
   - 尝试打开 PDF 文件（应该能正常打开）
   - 查看数学公式（应该正确渲染）

## 🔧 如果仍有问题

### 症状: PDF 文件仍然很大（> 1MB）
**可能原因**:
1. 内容包含大量数学公式
2. KaTeX 字体被完整嵌入
3. 浏览器缓存问题

**解决方案**:
1. 减少单个文档中的数学公式数量
2. 重启服务器: `Ctrl+C` 然后 `npm run server`
3. 清除浏览器缓存并刷新

### 症状: PDF 无法打开
**可能原因**:
1. 资源加载超时
2. KaTeX CSS 加载失败
3. 网络问题

**解决方案**:
1. 检查网络连接（需要访问 jsdelivr.net CDN）
2. 增加超时时间（修改 `pdf-generator-lib.ts` 中的 `timeout`）
3. 查看服务器日志错误信息

### 症状: 数学公式不显示
**可能原因**:
1. KaTeX CSS 未加载
2. 资源拦截过于严格

**解决方案**:
1. 检查服务器日志中的资源加载信息
2. 暂时禁用资源拦截进行测试

## 📝 注意事项

1. **首次生成较慢**: Puppeteer 需要启动浏览器（~3-5秒）
2. **后续生成快速**: 浏览器实例会被重用（~1-3秒）
3. **网络依赖**: 需要访问 CDN 加载 KaTeX CSS（可考虑本地化）
4. **中文支持**: 使用系统字体，Windows 上默认使用"微软雅黑"或"宋体"

## 🚀 下一步优化建议

1. **本地化 KaTeX**: 将 KaTeX CSS 和字体下载到本地，完全消除外部依赖
2. **字体子集化**: 只嵌入实际使用的字符，进一步减小文件
3. **压缩选项**: 添加 PDF 压缩选项
4. **缓存优化**: 缓存常用的 HTML 模板

